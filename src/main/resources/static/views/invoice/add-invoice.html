<div class="row wrapper animated fadeInLeft border-bottom white-bg pQuantity-heading">
    <div class="col-lg-8">
        <h2>Invoice</h2>
        <ol class="breadcrumb">
            <li>
                <a href="index.html">Home</a>
            </li>
            <li>
                Invoice
            </li>
            <li class="active">
                <strong>Add New Invoice</strong>
            </li>
        </ol>
    </div>

</div>
<div class="row">
    <div class="col-lg-12">
        <div class="wrapper wrapper-content animated fadeInRight" ng-controller="invoiceCtrl as inv">
            <!-- ########### invoice informations section start ############################################### -->
            <div class="ibox-title" style="background-color: #D3DAE3">
                <h5 ng-if="param === 'sell'">Sell Invoice</h5>
                <h5 ng-if="param === 'refund-sell'">Refund Sell Invoice</h5>
            </div>
            <div class="ibox-content">
                <div class="row">
                    <form name="invoiceForm" id="invoiceForm" role="form" ng-submit="addInvoice(invoiceForm)" class="form-horizontal" ng-validate="validateInvoice"
                        novalidate>
                        <div class="col-sm-6">

                            <div class="form-horizontal">
                                <label class="col-md-3 control-label">
                                    <h4 translate="ADDINVO.PAYMENTTYPE"></h4>
                                </label>
                                <div class="col-md-9 form-group">
                                    <ui-select ng-model="invoice.paymentType" class="ui-select">
                                        <ui-select-match placeholder="Select PaymentType">
                                            <span ng-bind="$select.selected.name"></span>
                                        </ui-select-match>
                                        <ui-select-choices repeat="payment in (payments | filter: $select.search) track by payment.id">
                                            <span ng-bind="payment.name"></span>
                                        </ui-select-choices>
                                    </ui-select>
                                </div>
                                
                                <!-- <div class="form-group">
                                    <label class="control-label form-group" style="font-size: 14px">
                                        <input icheck type="checkbox" ng-model="cashType.cash">
                                        نقدي
                                    </label>
                                </div> -->
                                
                            </div>
                            <div class="form-horizontal">
                                <label class="col-md-3 control-label">
                                    <h4 translate="ADDINVO.ACCOUNTTYPE"></h4>
                                </label>
                                <div class="col-md-9 form-group">
                                    <ui-select ng-model="invoice.account" class="ui-select" ng-mousedown="invoiceTypeNotNull()" ng-keydown="invoiceTypeNotNull()">
                                        <ui-select-match class="matchr" placeholder="Select Account">
                                            <span ng-bind="$select.selected.name"></span>
                                        </ui-select-match>
                                        <ui-select-choices repeat="account in (accounts | filter: $select.search) track by account.id">
                                            <span ng-bind="account.name"></span>
                                        </ui-select-choices>
                                    </ui-select>
                                </div>
                            </div>
                            <!-- <div class="form-horizontal">
                                <label class="control-label col-md-3">
                                    <h4 translate="ADDINVO.STORE"></h4>
                                </label>

                                <div class="col-md-7 form-group">
                                    <ui-select ng-model="selected.name" class="ui-select">
                                        <ui-select-match placeholder="Select Store">
                                            <span ng-bind="$select.selected.name"></span>
                                        </ui-select-match>
                                        <ui-select-choices repeat="">
                                            store in (stores | filter: $select.search) track by store.id
                                            <span ng-bind="store.name"></span>
                                        </ui-select-choices>
                                    </ui-select>
                                </div>
                                <div class="col-md-1">
                                    <button data-toggle="modal" type="button" data-target="#addStore" class="btn btn-success fa fa-plus fa-lg"></button>
                                </div>
                            </div> -->

                        </div>

                        <div class="col-sm-6 text-left">
                            <!-- <div class="form-group">
                                <div class="col-sm-3">
                                    <h4 translate="ADDINVO.INVOTYPE"></h4>
                                </div>
                                <div class="col-sm-9 input-group">
                                    <ui-select ng-model="invoice.invoiceType" class="ui-select" ng-change="getAccountByInvoType()">
                                        <ui-select-match placeholder="Select InvoiceType">
                                            <span ng-bind="$select.selected.name"></span>
                                        </ui-select-match>
                                        <ui-select-choices repeat="invoType in (invoTypes | filter: $select.search) track by invoType.id">
                                            <span ng-bind="invoType.name"></span>
                                        </ui-select-choices>
                                </div>
                            </div> -->
                            <div class=" form-group">
                                <div class="col-sm-3">
                                    <h4 translate="ADDINVO.REFERENCE"></h4>
                                </div>
                                <div class="col-sm-9 input-group">
                                    <input type="text" name="reference" class="form-control" ng-model="invoice.reference" />
                                </div>

                            </div>
                            <div class="form-group" moment-picker="invoice.invoiceDate" format="YYYY-MM-DD" start-view="month" today="true">
                                <div class="col-sm-3">
                                    <h4 translate="ADDINVO.INVODATE"></h4>
                                </div>
                                <div class="col-sm-9 input-group">
                                    <span class="input-group-addon">
                                        <i class="fa fa-calendar"></i>
                                    </span>
                                    <input class="form-control" placeholder="Select a date" ng-model="invoice.invoiceDate" ng-model-options="{ updateOn: 'blur' }">
                                </div>
                            </div>

                            <!-- <div class="form-horizontal">
                                <label class="control-label col-md-3">
                                    <h4 translate="ADDINVO.DISCOUNT"></h4>
                                </label>

                                <div class="col-md-7 form-group">
                                    <ui-select ng-model="invoice.discountType" class="ui-select">
                                        <ui-select-match placeholder="Select Discount">
                                            <span ng-bind="$select.selected.name"></span>
                                        </ui-select-match>
                                        <ui-select-choices repeat="discountType in (discountTypes | filter: $select.search) track by discountType.id">
                                            <span ng-bind="discountType.name"></span>
                                        </ui-select-choices>
                                    </ui-select>
                                    <input type="hidden" value="{{invoice.discountType}}" ng-model="invoice.discountType" name="inputItem" class="inputHidden">
                                </div>
                                <div class="col-md-1">
                                    <button data-toggle="modal" type="button" data-target="#addDiscount" class="btn btn-success fa fa-plus fa-lg"></button>
                                </div>
                            </div> -->
                        </div>
                    </form>
                </div>

            </div>



            <!-- ###########  Add product row start ############################################### -->
            <div class="ibox-title">
                <h5>اضافة منتج جديد للفاتورة</h5>
            </div>
            <div class="ibox-content">
                <form name="itemForm" role="form" ng-submit="addRow(itemForm)" class="form-horizontal" ng-validate="validateInvoiceItem"
                    novalidate>
                    <div class="row form-group">
                        <div class="col-md-5 form-group">
                            <div class=" col-md-4">
                                <label class="control-label pull-right" for="">Item</label>
                            </div>
                            <div class=" col-md-8">
                                <ui-select ng-model="invoiceItem.storeItem" class="ui-select" name="item" ng-change="discountUpdate()" required>
                                    <ui-select-match placeholder="">
                                        <span ng-bind="$select.selected.name"></span>
                                    </ui-select-match>
                                    <ui-select-choices 
                                    repeat="invoiceItem in (Items | filter: $select.search) track by invoiceItem.itemId"
                                    refresh="searchedItems($select.search)" refresh-delay="0">
                                        <span ng-bind="invoiceItem.name"></span>
                                    </ui-select-choices>
                                </ui-select>
                                <input type="hidden" value="{{invoiceItem.storeItem}}" name="inputItem" class="inputHidden">
                                
                            </div>
                        </div>
                        <div class=" col-md-4 form-group">
                            <label class="col-md-5 control-label">Discount</label>
                            <div class="col-md-7">
                                <div class="input-group m-b">
                                    <span class="input-group-addon">%</span>
                                    <input type="number" placeholder="" class="form-control" ng-model="invoiceItem.discountPercentage">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 form-group">
                            <label class="col-md-4 control-label" class="">Quantity</label>
                            <div class="col-md-8">
                                <input type="number" name="quantity" placeholder="" ng-model="invoiceItem.quantity" class="form-control">
                            </div>
                        </div>
                        <button class="btn btn-success" type="submit">Add</button>
                    </div>
                    <div class="row">
                        <div class="col-sm-5 form-group">
                            <div class=" col-md-4">
                                <label style="font-size: 14px" class="pull-right control-label">سعر الجمهور:</label>
                            </div>
                            <div class="col-md-8">
                                <input type="text" name="publicPrice" ng-value="invoiceItem.unitPrice=invoiceItem.storeItem.price" placeholder="" class="form-control" ng-model="invoiceItem.unitPrice" readonly>
                            </div>
                        </div>
                        <div class="col-sm-4 form-group">
                            <div class=" col-md-5">
                                <label style="font-size: 14px" class="pull-right control-label">المبلغ:</label>
                            </div>
                            <div class="col-md-7">
                                <input type="text" name="netPrice" ng-value="invoiceItem.totalPrice=invoiceItem.unitPrice * invoiceItem.quantity" placeholder="" class="form-control" ng-model="invoiceItem.totalPrice" readonly>
                            </div>
                        </div>
                        <div class="col-sm-3 form-group">
                            <div class=" col-md-4">
                                <label style="font-size: 14px">المبلغ الصافي</label>
                            </div>
                            <div class="col-md-8">
                                <input type="text"  ng-bind="invoiceItem.totalNetPrice = priceAfterDiscount(invoiceItem.totalPrice, invoiceItem.discountPercentage)" placeholder="" ng-model="invoiceItem.totalNetPrice" class="form-control" readonly>
                            </div>
                        </div>
                    </div>
                </form>
            </div>


                                    <!-- ########### products table section start ############################################### -->
                                    <div class="ibox-title">
                                        <h5>قائمة المنتجات المضافة</h5>
                                    </div>
                                    <div class="table-responsive ibox-content">
                                        <input type="text" class="form-control input-sm m-b-xs" id="filter" placeholder="Search in table">
                                    
                                        <table class="table table-hover table-striped footable" data-paging-container="#paging-ui-container" data-paging-count-format="{CP} of {TP}"
                                            data-paging="true" data-paging-size="5" data-filter=#filter>
                                            <thead>
                                                <tr>
                                                    <th>No</th>
                                                    <th>Product</th>
                                                    <th>Quantity</th>
                                                    <th>Price</th>
                                                    <th class="text-left">Total</th>
                                                    <th class="text-left">Edit</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr ng-repeat="invoiceItem in invoiceItems track by $index">
                                                    <td>{{$index+1}}</td>
                                                    <td>
                                                        <span data-ng-hide="invoiceItem.editMode">{{invoiceItem.storeItem.name}}</span>
                                                        <ui-select ng-model="invoiceItem.storeItem" class="ui-select" data-ng-show="invoiceItem.editMode" name="item" ng-change="discountUpdate()" required>
                                                            <ui-select-match placeholder="">
                                                                <span ng-bind="$select.selected.name"></span>
                                                            </ui-select-match>
                                                            <ui-select-choices repeat="invoiceItem in (Items | filter: $select.search) track by invoiceItem.itemId" refresh="searchedItems($select.search)"
                                                                refresh-delay="0">
                                                                <span ng-bind="invoiceItem.name"></span>
                                                            </ui-select-choices>
                                                        </ui-select>
                                                    </td>
                                                    <td>
                                                        <span data-ng-hide="invoiceItem.editMode">{{invoiceItem.quantity}}</span>
                                                        <input type="number" data-ng-show="invoiceItem.editMode" data-ng-model="invoiceItem.quantity" class="form-control" ng-change="update()" data-ng-required
                                                        />
                                                    </td>
                                                    <td>
                                                        <span data-ng-hide="invoiceItem.editMode">{{invoiceItem.unitPrice | currency: currencySymbol}}</span>
                                                    </td>
                                                    <td class="text-left">
                                                        <span data-ng-hide="invoiceItem.editMode">{{invoiceItem.totalNetPrice | currency: currencySymbol}}</span>
                                                    </td>
                                                    <td class="text-left">
                                                        <button type="submit" data-ng-hide="invoiceItem.editMode" data-ng-click="invoiceItem.editMode = true; editRow($index)" class="btn btn-default">Edit</button>
                                                        <button type="submit" data-ng-hide="invoiceItem.editMode" data-ng-click="deleteRow($index)" class="btn btn-default">Delete</button>
                                                        <button type="submit" data-ng-show="invoiceItem.editMode" data-ng-click="invoiceItem.editMode = false; saveField()" class="btn btn-default">Save</button>
                                                    </td>
                                                </tr>
                                                <tr>
                                    
                                                </tr>
                                            </tbody>
                                        </table>
                                        <div id="paging-ui-container"></div>
                                    </div>
                                    <!-- ########### products table section end ############################################### -->

            <!-- ###########Total pyament and taxes section start ############################################### -->
            <div class=" ibox-content">
                <div class="table-responsive">
                    <table class="table col-md-7 pull-right" id="tab_logic_total">
                        <tbody>
                            <tr>
                                <th class="text-center col-md-4">Sub Total</th>
                                <td class="text-right">
                                    {{subTotal() | currency: currencySymbol}}
                                </td>
                            </tr>
                            <tr ng-hide="emptyDiscounts()==false">
                                <th class="text-center">Discount</th>
                                <td>
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Status</th>
                                                    <th>NAME</th>
                                                    <th>PER</th>
                                                    <th>VALUE</th>
                                                    <th>CostWithDis</th>
                                
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr ng-hide="settings.discount1Valu == 0">
                                                    <td>
                                                        <input icheck type="checkbox" ng-model="dis1ckb">
                                                    </td>
                                                    <td>{{settings.discount1Name}}</td>
                                                    <td>{{settings.discount1Valu}}</td>
                                                    <td>{{dis1ckb ? settings.discount1Valu * subTotal() / 100 : 0}}</td>
                                                    <td>{{dis1ckb ? subTotal() - (subTotal() / 100 * settings.discount1Valu) : 0}}</td>
                                                </tr>
                                                <tr ng-hide="settings.discount2Valu == 0">
                                                    <td>
                                                        <input icheck type="checkbox" ng-model="dis2ckb">
                                                    </td>
                                                    <td>{{settings.discount2Name}}</td>
                                                    <td>{{settings.discount2Valu}}</td>
                                                    <td>{{dis2ckb ? settings.discount2Valu * subTotal() / 100 : 0}}</td>
                                                    <td>{{dis2ckb ? subTotal() - (subTotal() / 100 * settings.discount2Valu) : 0}}</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </td>
                            </tr>

                            <tr ng-hide="emptyTaxes() == false">
                                <th class="text-center">Taxes</th>

                                <td>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Status</th>
                                                <th>NAME</th>
                                                <th>PER</th>
                                                <th>VALUE</th>
                                                <th>CostWithTax</th>

                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr ng-hide="settings.tax1Value == 0">
                                                <td><input icheck type="checkbox" ng-model="tax1ckb"></td>
                                                <td>{{settings.tax1Name}}</td>
                                                <td>{{settings.tax1Value}}</td>
                                                <td>{{tax1ckb ? settings.tax1Value * subTotal() / 100 : 0}}</td>
                                                <td>{{tax1ckb ? (settings.tax1Value * subTotal() / 100) + subTotal() : 0}}</td>
                                            </tr>

                                            <tr ng-hide="settings.tax2Value == 0">
                                                <td>
                                                    <input icheck type="checkbox" ng-model="tax2ckb">
                                                </td>
                                                <td>{{settings.tax2Name}}</td>
                                                <td>{{settings.tax2Value}}</td>
                                                <td>{{tax2ckb ? settings.tax2Value * subTotal() / 100 : 0}}</td>
                                                <td>{{tax2ckb ? (settings.tax2Value * subTotal() / 100) + subTotal() : 0}}</td>
                                            </tr>

                                            <tr ng-hide="settings.tax3Value == 0">
                                                <td>
                                                    <input icheck type="checkbox" ng-model="tax3ckb">
                                                </td>
                                                <td>{{settings.tax3Name}}</td>
                                                <td>{{settings.tax3Value}}</td>
                                                <td>{{tax3ckb ? settings.tax3Value * subTotal() / 100 : 0}}</td>
                                                <td>{{tax3ckb ? (settings.tax3Value * subTotal() / 100) + subTotal() : 0}}</td>
                                            </tr>

                                            <tr ng-hide="settings.tax4Value == 0">
                                                <td>
                                                    <input icheck type="checkbox" ng-model="tax4ckb">
                                                </td>
                                                <td>{{settings.tax4Name}}</td>
                                                <td>{{settings.tax4Value}}</td>
                                                <td>{{tax4ckb ? settings.tax4Value * subTotal() / 100 : 0}}</td>
                                                <td>{{tax4ckb ?(settings.tax4Value * subTotal() / 100) + subTotal() : 0 }}</td>
                                            </tr>

                                            <tr ng-hide="settings.tax5Value == 0">
                                                <td>
                                                    <input icheck type="checkbox" ng-model="tax5ckb">
                                                </td>
                                                <td>{{settings.tax5Name}}</td>
                                                <td>{{settings.tax5Value}}</td>
                                                <td>{{tax5ckb ? settings.tax5Value * subTotal() / 100 : 0}}</td>
                                                <td>{{tax5ckb ? (settings.tax5Value * subTotal() / 100) + subTotal() : 0}}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                </td>
                            </tr>
 
                            <tr>
                                <th class="text-center">Grand Total</th>
                                <td class="text-right">
                                    <div class="form-group col-md-2">{{calculateGrandTotal()}}</div>
                                </td>
                            </tr>
                            <!-- ###########Total pyament and taxes section end ############################################### -->
                        </tbody>
                    </table>
                </div>
                <div class="">
                    <button class="btn btn-success" ng-click="addInvoice(invoiceForm)" translate="ADDINVO.SAVE"></button>
                    <button class="btn btn-success" ng-click="resetInvoice()" translate="ADDINVO.NEW"></button>
                </div>
            </div>


            <!-- line discount modal -->
            <div class="modal fade" id="addDiscount" tabindex="-1" role="dialog" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">
                                <span aria-hidden="true">×</span>
                                <span class="sr-only">Close</span>
                            </button>
                            <h3 class="modal-title">Add New Discount Type</h3>
                        </div>
                        <div class="modal-body">

                            <!-- content goes here -->
                            <form name="discountTypeForm" ng-submit="adddiscountType(discountTypeForm)" ng-validate="validatediscountTypeForm">
                                <div class="form-group">
                                    <label for="name">Discount Name:</label>
                                    <input type="text" class="form-control" name="name" id="name" placeholder="Discount Name" ng-model="discountType.name">
                                </div>
                                <button type="submit" class="btn btn-default">Save</button>
                            </form>

                        </div>
                        <div class="modal-footer">

                        </div>
                    </div>
                </div>
            </div>


            <!-- line store modal -->
            <div class="modal fade" id="addStore" tabindex="-1" role="dialog" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">
                                <span aria-hidden="true">×</span>
                                <span class="sr-only">Close</span>
                            </button>
                            <h3 class="modal-title">Add New Store</h3>
                        </div>
                        <div class="modal-body">

                            <!-- content goes here -->
                            <form ng-submit="addStore()">
                                <div class="form-group">
                                    <label for="name">Store Name:</label>
                                    <input type="text" class="form-control" id="name" placeholder="Store Name" ng-model="store.name">
                                </div>
                                <div class="form-group">
                                    <label for="name">Note:</label>
                                    <textarea name="note" id="note" rows="3" class="form-control" ng-model="store.note"></textarea>
                                </div>
                                <button type="submit" class="btn btn-default">Save</button>
                            </form>

                        </div>
                        <div class="modal-footer">

                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>